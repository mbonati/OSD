<!DOCTYPE html>
<html lang="en">

<head>
    <title>OpenSpendingReview - Spese Correnti</title>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- JQuery -->
    <script src="http://code.jquery.com/jquery-1.8.2.js"></script>
    <script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
    <link href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" type="text/css" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="./js/bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet">
    <link href="./js/bootstrap/css/bootstrap-responsive.css" type="text/css" rel="stylesheet">
    <script src="./js/bootstrap/js/bootstrap.min.js"></script> 

    <!-- D3.js -->
    <script src="http://d3js.org/d3.v2.js"></script>
    
    <!-- Uniform.js -->
    <script src="js/uniform.js/jquery.uniform.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="js/uniform.js/css/uniform.default.css" type="text/css" media="screen">
    
    <!-- jqGrid -->
    <script src="js/jqGrid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="js/jqGrid/js/i18n/grid.locale-it.js"></script>
    <link rel="stylesheet" href="js/jqGrid/css/ui.jqgrid.css" type="text/css" media="screen">

    <!-- CrossFilter -->
    <script src="js/square.crossfilter/crossfilter.min.js" type="text/javascript"></script>
    
    <!-- dc.js -->
    <script type="text/javascript" src="js/dc.js/dc.min.js"></script>
    <link rel="stylesheet" href="js/dc.js/dc.css" type="text/css" media="screen">
    
    <style>
      body {
        font-family:"Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif; 
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>

 </head>
 
<body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">OpenSpendingReview</a>
          <div class="nav-collapse collapse">
            
            <!-- Navigation Menu -->
            <ul class="nav pull-left">
              <li class="active"><a href="index.html">Spese Correnti</a></li>
              <li><a href="indicatoriFinanziari.html">Indicatori Finanziari</a></li>
              <li><a href="bilanci.html">Bilanci</a></li>
            </ul>
              
            <!-- Login -->
            <ul class="nav pull-right">
                <li><a href="/users/sign_up">Sign Up</a></li>
                <li class="divider-vertical"></li>
                <li class="dropdown">
                    <a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
                    <div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
                        <!-- Login form here -->
                        <form action="[YOUR ACTION]" method="post" accept-charset="UTF-8">
                          <input id="user_username" style="margin-bottom: 15px;" type="text" name="user[username]" size="30" placeholder="Username" />
                          <input id="user_password" style="margin-bottom: 15px;" type="password" name="user[password]" size="30" placeholder="Password" />
                          <input id="user_remember_me" style="float: left; margin-right: 10px;" type="checkbox" name="user[remember_me]" value="1" />
                          <label class="string optional" for="user_remember_me"> Remember me</label>
                          <input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
                        </form>
                    </div>
                </li>
            </ul>
            
            <!-- Search Box -->
            <!--
            <form class=navbar-search pull-right">
                <input type="text" class="search-query" placeholder="Search">
            </form>
            -->

            </div><!--/.nav-collapse -->
        
        </div>
      </div>
    </div>

    <div class="container">

        <div class="row-fluid">
            <div class="span9 year-selection-container">
                <div class="section-label"><h4>Selettore<h4></div>
                  <div id="fluctuation-chart" >
                        <span>Periodo</span>
                        <a class="reset" href="javascript:fluctuationChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clear"></div>
                </div>
            </div>
            <div class="span3 year-selection-container">
                <div class="section-label"><h4>Filtri<h4></div>
                <div class="dc-data-count">
                    <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
                </div>
            </div>
        </div>
        
        <div class="row">
          <div class="span9 viz-container section-label">
            <ul class="nav nav-tabs" id="viz-tab">
                <li><a href="#determine" data-toggle="tab">Determinazioni</a></li>
                <li><a href="#speseDL" data-toggle="tab">Spese D.L. n.83/2012</a></li>
            </ul>
            
            <div class="tab-content">
                  <div class="tab-pane table-container" id="determine">
                        <table class="dc-data-table">
                            <thead>
                            <tr class="header">
                                <td>#</td>
                                <td>Comune</td>
                                <td>Descrizione</td>
                                <td>Importo</td>
                                <td>Data</td>
                            </tr>
                            </thead>
                        </table>
                  </div>    
                  <div class="tab-pane table-container" id="speseDL">
                        <table id="speseDL-table"></table>
                        <div id="speseDL-table-pager"></div>
                  </div>
               </div>  
          </div>


           <div class="span3 filter-container">
                <div id="importi-chart" >
                        <span>Importi </span>
                        <a class="reset" href="javascript:importiChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clear"></div>
                </div>
           </div>
          
            <div class="span3 filter-container">
                  <div id="comuni-chart" >
                        <span>Importi </span>
                        <a class="reset" href="javascript:comuniChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clear"></div>
                </div>
            </div>
        </div>

    </div> <!-- /container q -->
    
    <div id="viz-tooltip">
        <div id ="viz-tooltip-container">
            <span class="viz-tooltip-value"></span>
            <div class="nytg-tail"></div>
        </div>
    </div>

</body>

<script type="text/javascript">

var fluctuationChart = dc.barChart("#fluctuation-chart");
var importiChart = dc.pieChart("#importi-chart");
var comuniChart = dc.pieChart("#comuni-chart");

// set dc.js version in title
d3.selectAll("#version").text(dc.version);

// load data from a csv file
//d3.csv("ndx.csv", function(data) {
d3.json("https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=agg_det_com&query=select%20comune%2Ccodice%2CDataSalvataggio%2Cdescrizione%2Cimporto%20from%20%60swdata%60" , function(delibere){ 

            // since its a csv file we need to format the data a bit
            var dateFormat = d3.time.format("%B %d, %Y");
            var numberFormat = d3.format(".2f");

            delibere.forEach(function(e) {
                e.DataSalvataggio = parseDate(e.DataSalvataggio);
                //e.month = d3.time.month(e.dd); // pre-calculate month for better performance
            });

            function parseDate(input) {
                var parts = input.match(/(\d+)/g);
                // new Date(year, month [, date [, hours[, minutes[, seconds[, ms]]]]])
                var ret = new Date(parts[0], parts[1]-1, parts[2]); // months are 0-based
                //console.log("parse date called for "+input + " result: " +ret);
                return ret;
             }
  
            // feed it through crossfilter
            var delibereCF = crossfilter(delibere);
            var all = delibereCF.groupAll();
            
            var date = delibereCF.dimension(function(d){ return d.DataSalvataggio;} );
            var dates = date.group();

             //dimensione Comune
              var dimComuni = delibereCF.dimension(function(d){ return d.comune;} );
              var grpComuni = dimComuni.group();
              
              //dimensione Importo
              //var dimImporti = delibereCF.dimension(function(d){ return d.importo;} );
              var dimImporti = delibereCF.dimension(function(d){
                            if (d.importo <= 1000)
                                return "< 1K";
                            else if (d.importo > 1000 && d.importo <= 100000)
                                return "< 100K";
                            else if (d.importo > 100000 && d.importo <= 1000000)
                                return "< 1M";
                            else
                                return "> 1M";                 
                            });
              var grpImporti = dimImporti.group();
            /*var dateDimension = ndx.dimension(function(d) {
                return d.dd;
            });

            // monthly index avg fluctuation in percentage
            var moveMonths = ndx.dimension(function(d) {
                return d.month;
            });
            var monthlyMoveGroup = moveMonths.group().reduceSum(function(d) {
                return Math.abs(+d.close - +d.open);
            });
            var volumeByMonthGroup = moveMonths.group().reduceSum(function(d) {
                return d.volume / 500000;
            });
            var indexAvgByMonthGroup = moveMonths.group().reduce(
                    function(p, v) {
                        ++p.days;
                        p.total += (+v.open + +v.close) / 2;
                        p.avg = Math.round(p.total / p.days);
                        return p;
                    },
                    function(p, v) {
                        --p.days;
                        p.total -= (+v.open + +v.close) / 2;
                        p.avg = p.days==0?0:Math.round(p.total / p.days);
                        return p;
                    },
                    function() {
                        return {days:0, total:0, avg:0};
                    }
            );

            var gainOrLoss = ndx.dimension(function(d) {
                return +d.open > +d.close ? "Loss" : "Gain";
            });
            var gainOrLossGroup = gainOrLoss.group();

            var fluctuation = ndx.dimension(function(d) {
                return Math.round((d.close - d.open) / d.open * 100);
            });
            var fluctuationGroup = fluctuation.group();
            */


            fluctuationChart.width(820)
                    .height(180)
                    .margins({top: 10, right: 50, bottom: 30, left: 40})
                    .dimension(date)
                    .group(dates)
                    .elasticY(true)
                    .centerBar(true)
                    .gap(0)
                    .round(d3.time.day.round)
                    .xUnits(d3.time.days)
                    .x(d3.time.scale().domain([new Date(2012, 0, 1), new Date(2012, 12, 31)]))
                    .renderHorizontalGridLines(true)
                    .xAxis();
                    
            importiChart.width(180)
                    .height(180)
                    .radius(80)
                    .innerRadius(30)
                    .dimension(dimImporti)
                    .group(grpImporti);

            comuniChart.width(180)
                    .height(180)
                    .radius(80)
                    .colors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
                    .innerRadius(30)
                    .dimension(dimComuni)
                    .group(grpComuni);
                    
            dc.dataCount(".dc-data-count")
                    .dimension(delibereCF)
                    .group(all);

            dc.dataTableExt(".dc-data-table")
                    .dimension(date)
                    //.group(all)
                    .group(function(d) {
                        var format = d3.format("02d");
                        return d.DataSalvataggio.getFullYear() + "/" + format((d.DataSalvataggio.getMonth() + 1));
                    })
                    .size(100)
                    .columns([
                        function(d) { return d.codice; },
                        function(d) { return d.comune; },
                        function(d) { return d.descrizione; },
                        function(d) { return d.importo; },
                        function(d) { return d.DataSalvataggio; }
                    ])
                    .sortBy(function(d) {
                        return d.DataSalvataggio;
                    })
                    .order(d3.ascending);

            dc.renderAll();
        }
);

dc.dataTableExt = function(parent, chartGroup) {
    var _chart = dc.baseChart({});

    var _size = 25;
    var _columns = [];
    var _sortBy = function(d) {
        return d;
    };
    var _order = d3.ascending;
    var _sort;

    _chart.doRender = function() {
        _chart.selectAll("tbody").remove();

        renderRows(renderGroups());

        return _chart;
    };

    function renderGroups() {
        var groups = _chart.root().selectAll("tbody")
            .data(nestEntries(), function(d) {
                return _chart.keyAccessor()(d);
            });

        var rowGroup = groups
            .enter()
            .append("tbody");

        /*rowGroup
            .append("tr")
            .attr("class", "group")
                .append("td")
                .attr("class", "label")
                .attr("colspan", _columns.length)
                .text(function(d) {
                    return _chart.keyAccessor()(d);
                });*/

        groups.exit().remove();

        return rowGroup;
    }

    function nestEntries() {
        if (!_sort)
            _sort = crossfilter.quicksort.by(_sortBy);

        var entries = _chart.dimension().top(_size);

        return d3.nest()
            .key(_chart.group())
            .sortKeys(_order)
            .entries(_sort(entries, 0, entries.length));
    }

    function renderRows(groups) {
        var rows = groups.order()
            .selectAll("tr.row")
            .data(function(d) {
                return d.values;
            });

        var rowEnter = rows.enter()
            .append("tr")
            .attr("class", "row");

        for (var i = 0; i < _columns.length; ++i) {
            var f = _columns[i];
            rowEnter.append("td")
                .attr("class", "column " + i)
                .text(function(d) {
                    return f(d);
                });
        }

        rows.exit().remove();

        return rows;
    }

    _chart.doRedraw = function() {
        return _chart.doRender();
    };

    _chart.size = function(s) {
        if (!arguments.length) return _size;
        _size = s;
        return _chart;
    };

    _chart.columns = function(_) {
        if (!arguments.length) return _columns;
        _columns = _;
        return _chart;
    };

    _chart.sortBy = function(_) {
        if (!arguments.length) return _sortBy;
        _sortBy = _;
        return _chart;
    };

    _chart.order = function(_) {
        if (!arguments.length) return _order;
        _order = _;
        return _chart;
    };

    return _chart.anchor(parent, chartGroup);
};
</script>


