import scraperwiki
import mechanize
import lxml.html           


def scrapeSinglePage(page, codiceEnte): 
    "scarica indiciatori del singolo comune"
    htmlPage = scraperwiki.scrape(page)
    print htmlPage 
    rootTot = lxml.html.fromstring(htmlPage)
    #estrai nome ente
    tds = rootTot.cssselect("td.asinistra")
    for td in tds:
        spans = td.cssselect("span")
        if len(spans)==1:
            print(spans[0].text_content())
            nomeEnte = spans[0].text_content()

    spans = rootTot.cssselect("span.titoliblu")
    nomeEnte = spans[1].text_content()

    #estrai indicatori
    tables = rootTot.cssselect("table.tabfin")
    for table in tables:
        rows = table.cssselect("tr")
        for row in rows:
            print(row)
            tds = row.cssselect("td")
            print(len(tds))
            if len(tds)>5:
                print(tds[0].text_content())
                if len(tds[0].text_content())>2:
                    data = {
                           'codiceEnte' : codiceEnte,
                           'nomeEnte' : nomeEnte,
                           'indicatore' : tds[0].text_content().strip(),
                           'valoreEnte' : tds[1].text_content().strip(),
                           'diffPercEnte_Provincia' : tds[2].text_content().strip()
                    }
                    print data
                    scraperwiki.sqlite.save(unique_keys=['codiceEnte','indicatore' ], data=data)
    return;
            

arrayCodici = {
"2050540010","1030990010","1030980010","3090750010","5200950010","4130600010","1030490020",
"3090630010","4170640010","5190650010","4160310010","1010270010","4170470010","4130380010",
"3120690010","4170640020","4150720010","4150510010","5190210010","5190210020","5190210030",
"5190210040","3110440010","3120330010","4180250010","1030150010","3110590010","1030260010",
"1030450010","3120910010","4180250020","4160410010","4181030010","3110060010","3100800010",
"4140190010","4160090010","3110060020","5190180010","5190480001","1010020010","4180250030",
"3120330020","4160090020","5190210060","1030120010","1030120020","2050710010","1030150020",
"2050890010","3120700010","4150510020","4180670010","2080610010","4150510030","5200730010",
"5190280010","3090630020","1010070010","5200730011","2050540020","1030260020","4180670020",
"4140940020","1030150030","2050100010","3120700020","1030860010","1030490030","1010520010",
"5190010010","4150720020","3110030010","2050900010","1030490040","5200950020","5190280020",
"4130380020","4180250040","2060850010","4150080010","4180250050","4150200010","1010960010",
"1010810020","4150110010","1070370010","1030980020","1010270020","2040830010","1010810030",
"1030570010","1010880020","4130600020","2050100020","1070740010","3120330030","1010270030",
"4130790001","5200950030","1030490050","4150720030","4170640030","3120700030","1010880030",
"1030570020","1030770010","2080560010","1010270040","1030240030","1070740020","1010020020",
"4160090030","4160310020","1030240040","2050900020","4180220020","2040830020","1030490060",
"4180250060","2050540030","2080680010","1030120040","1030240050","1070740040","1070740030",
"1030860020","1030570030","1030770020","1010070020","1030570040","5190820010","5190480010",
"2040830030","2040140002","5200950040","1010020030","4180250070","5190010020","4160410020",
"4160410030","4150720040","4130380030","1030150040","1010020040","2080660010","5200730030",
"1030120041","5190550010","4170470020","1010020050","1010880040","1010810050","4150200020",
"5190550020","5190550030","5200950050","2050100030","1020040010","3100800020","4160410040",
"3120700040","1030120070","1030120080","1010810060","2050900030","1010810070","1010810080",
"2080610020","1030240060","4160090040","1070740050","4150080020","5190550040","1010020070",
"4150720050","2050900040","3110060030","4180250080","4130230010","2050900050","2050840010",
"1010270050","5190550050","4180250090","3090430010","3100800030","4150200030","3120330040",
"1030120090","1010020080","1030240070","4150720060","3110060040","4180250100","2060850020",
"4180220030","3120330050","4180220040","3120690020","1030120100","2040830040","1070390010",
"3100800040","4180250110","1010520020","4150110020","2060850030","4150510040","3120330060",
"4130790010","3110030020","4180220050","2040830050","1030770030","1010810090","1070740060",
"1010960020","4160410050","1010810100","2060930010","4150080030","4160090050","2040140001",
"5200730040","1030150050","1030860030","3090050010","2050890030","1030150060","4150720070",
"1010810110","3120700050","2050540040","1030260030","1030980030","2050870010","4180670030",
"1030120110","2040140010","3120700060","1010070030","5190480040","4180670040","3120690030",
"1011020010","4130380040","1030240090","4160310030","4170640040","3120700070","1020040030",
"3110590020","4150110030","3110440020","4150110040","1030240100","2040140020","3110440030",
"3110060050","1030770040","1070370020","4160310040","4180250120","3120400010","4150720080",
"2060850040","4150080040","3120330070","4160410060","5190010030","1010070040","2060930020",
"5200950060","1010880060","5200170010","2050840020","3120330080","1030120120","3110030030",
"4130230020","3090360010","3120700080","1030860040","2040830060","1070390020","2050890040",
"1030490070","1030490080","2050900060","5200730050","5200950070","3120700081","1030770050",
"1030120130","4180670050","4181030020","1030570050","1070340010","1030490090","3090050020",
"1030240110","2080130020","2080290010","1010270060","1010270070","4180220070","4130230030",
"4150080050","2050710020","3120700090","4130230040","4150200040","1010810120","5200530010",
"1011020030","3120910020","1030490100","1010520060","4170640050","1070370040","5200170020",
"1020040040","3120330090","1070740070","4160410070","1011020040","1010520070","1030240120",
"4150110050","4150110060","3120330100","3110060060","1010020090","2050540060","3100800050",
"1030860050","2050900070","4130790020","3120700100","2060850050","2060850060","3120700110",
"1030150061","1020040050","5200730060","5200530020","4150510050","2060930030","2050540070",
"2050900080","3090750020","3110060070","4160310050","3120690040","2050900090","2050900100",
"1010880070","1030450020","2050840030","1030490110","5200170030","3100580010","1030240130",
"5200950080","5190280030","1010070050","5200950090","4130380050","4170640060","4150720100",
"4130230050","3120330110","4150720110","4130790030","4150080060","3100800060","2060850070",
"5200530030","3110590030","5190760010","4150720120","3090460010","1011020050","1070370041",
"2050100050","3120330120","5200530040","1070340020","2040140021","4150080070","4150080080",
"1030120150","4150200050","4160780010","4130380060","2060930040","1030120160","1010810130",
"4170640070","3100800061","2040830070","1020040060","5190760020","1010020100","1020040070",
"1020040080","1010810140","1030260040","2060930050","1030150062","1030120170","1030860060",
"1030860061","1030120180","1011020060","4150510060","1070370050","5200730061","2040140030",
"2050890050","1030570060","2050710040","3090050030","4180220080","4180670060","5190550060",
"2080660020","4180670070","2080660030","1030570070","2060850080","1010270080","1030120181",
"3090430020","3090300010","2080320010","4140940030","2050540080","4150080090","1030260050",
"4160410080","2050710050","2080680020","1030150070","1010270090","1030450030","3090460020",
"3120910030","1030150080","4150200060","4150080100","1010810150","2080680030","1070370060",
"1010810160","1010810170","1010810180","5190550070","1070740080","1030980040","5200170040",
"1010810190","1010880080","1010880090","4130380070","4170640080","1010020110","5200730070",
"1010810200","1011020070","4170640090","2050540090","5200950100","4170640100","4140190020",
"1030490116","1030860062","5200950110","1010810210","3110030040","3120910040","2050900110",
"1010270110","1030150090","1030120190","3090300020","1030570080","2040140040","2050540100",
"5190480050","3110590040","2060930060","1020040090","1030860070","2080560020","1070740090",
"2050890060","1010810220","1030490120","1010520110","5200950120","4130380080","3090430030",
"1070340030","1010270120","1030150091","4160090060","5200530050","1030120200","2080130030",
"4170640110","4130380090","1030490130","4160090070","1030240150","1010270130","1010810230",
"4150720130","5190280040","5200170050","4130380100","5200170060","1030980050","1030120210",
"1030980070","1010020120","3100800070","4130790040","4150110070","1030490140","1030490150",
"2060850090","1030150100","2050900120","3120910051","3120910052","3120400020","1010020130",
"3100580020","1030570110","2080500010","2050540110","1010270150","4150720140","1030570120",
"5190550080","5200950130","5200530060","1011020080","2080130040","1030860080","1030150110",
"2040830110","2080560030","1030120220","1011020090","1010810240","1010270160","4180220090",
"2050890070","3110440040","1010020140","1030570130","1011020100","4170640120","1030240190",
"1030980080","4130790050","3120700120","1010270170","1030490160","1010520150","4150720141",
"4150200070","4150720150","2050100060","1030490170","4180250130","3120330130","4140940040",
"3120690050","5190550090","3110060080","5190210070","4180250140","4180970010","1010270180",
"4180250150","3110030050","1010070080","5200530070","1030770060","1030240210","1010270190",
"4180670080","5200730080","1010270200","4150110080","1010960030","2080130050","1030120230",
"1030770070","2080560040","5200730090","1030240220","1030570140","1010020150","1030120240",
"2050710060","1070740100","1010270210","1030150120","4170470030","1030490180","1030490190",
"1010270220","2080290020","2040830120","2080320020","2060850100","1030990020","1010070090",
"1010020160","1030150130","1030150140","1030120250","1030490210","1030860081","1030490220",
"2040830130","2080610030","1030860090","1030860100","5200730100","2080610040","3100580030",
"3100580040","1070390030","2050890080","2040830140","5190210080","4180250160","4180670090",
"1010520170","1030860110","1030120251","1030770080","1030490230","2080680040","3090050040",
"3090420010","1010810250","4160310060","2060850110","1010960040","1030150150","2040830150",
"3090620020","1030450040","1030240230","1030490240","4160090080","1010960050","1020040100",
"1030150160","5200530080","4150080110","5190550100","4160090090","4130380110","4130790060",
"4180250170","1010020170","1030860120","4160090100","4160090110","4160090120","5200530090",
"5190010040","4180670100","1030240240","2040830160","2040830170","1030120260","3120910060",
"1030240250","1030240260","5190550101","2050540120","2080610050","1010810260","1010520180",
"4180250180","1010880140","2040830180","1030860130","1030490260","1070340040","1011020120",
"1010520200","1070740110","4140190030","1070390040","2040830190","1030120270","1030490270",
"1010810270","2080130060","4130600030","5190550110","3110440050","5200530100","3120910070",
"1030120280","2040140050","1010520210","2050900130","3120910080","4130230060","5190180020",
"5190550120","2080500020","5200950150","1070390050","1030120290","1030120300","2050890090",
"2080290030","2040830200","2040830201","4150110090","4140190040","1030260060","4180250190",
"4150080120","5200730110","5200730120","5200730130","1010270230","3120690060","2050100070",
"2060850120","1070370070","1030260070","2080560050","2080680050","1030570141","1010810280",
"5190550130","1010020180","1070390060","1030990040","1070740120","2080320030","4180220110",
"1010810290","1070740130","3090430040","1030120310","3110590060","1030570150","1010270250",
"1030150170","1030990050","3090300040","1010020200","1030570170","1010520240","2080130070",
"2080560060","2040830210","3120690071","1010880170","1030450050","1030450060","1010520220",
"1010270240","1010520230","1070370090","1010810310","1010810320","2080610060","1010020190",
"1030570160","2050540130","3120690072","1030150180","1010880160","1070740140","1030770090",
"1030570180","1030150190","5200950160","5200530110","4130230070","1010960060","2050840040",
"5200530120","5200730140","5200730150","1070340050","5200530130","2050710070","2050890110",
"1010020210","1010810330","4150510080","4150510090","2040830220","1010270260","1010020220",
"1030980090","1030570190","1030120320","1010270270","4180220111","4160410081","1030120330",
"1030150200","5200730160","4180670110","4180670130","4180670120","1030150210","1010270280",
"1030150220","3120330140","4160310070","2050540140","2050890120","1010020230","1030450070",
"1010270290","1030120331","3120700130","4150720160","2040140060","1030570191","4180670140",
"1030150230","1010810340","1030120350","1030150240","1030860140","2050840050","1030860150",
"2050900140","1030240280","2040830230","1010880190","1030120360","1030120370","1030120380",
"1030990060","1030570200","2050900150","1030240290","2040140070","1030150250","1030860151",
"2050890130","2040830240","2050890140","2080680060","1030150260","2040830250","1030570210",
"2040140080","2050900160","1030490320","2040830260","1030860152","1010270300","4181030030",
"1010810350","1030240300","4170640130","1010270310","1010520250","1010020240","4160160010",
"4170640140","1030860160","1010520260","2040830270","1030150270","1030490330","2080660040",
"1020040110","4130600040","1030980100","3120330150","2050900170","4181030040","5190480070",
"1010270320","1030570220","5190210090","2040140090","1010270330","1010810360","1010810370",
"1030490340","2050540150","1070390070","2060930070","1010810380","1030120400","1030240320",
"1030860171","2040140100","1010070100","1030120401","1010810390","4150510100","1030860180",
"1010960070","1020040120","1010810400","4180670150","1030490350","1010070110","5190760030",
"4130230080","4150110100","1030490360","4150720170","3090050050","2060930080","5200530131",
"2080130080","5200170070","3090630030","1030770100","4130380120","1030860181","2060850130",
"1030980110","1030240340","5200730180","5200730190","4150720180","4150110110","3090750030",
"4180250200","1030490370","5200170080","5190010050","5200730200","1010810410","1010810420",
"1010880210","5200950170","1070340060","2080680070","1010810430","1010270340","1030490380",
"5190760040","5190820020","1030490390","1030490400","2080560070","4130600050","4140190050",
"2050890150","1010810440","1030860190","1030490410","5190180030","3090620030","2050890160",
"1010810450","2060850140","1010020250","1030240350","5200950180","5190550140","4180970020",
"2080680080","2080610070","2040830280","2050540160","1030240360","1030860210","2050840060",
"1010810460","4150720190","3110590070","5200170090","1030240370","4130380130","4160310080",
"1030240380","4150200080","4150200090","2040140110","1030150271","1030770110","4150080130",
"1030860220","1070740150","4150510110","4150080140","2050100080","1010070130","5190010060",
"5200730210","4180670160","5190280050","4130380140","5200170100","5190210100","5190820030",
"2040830291","3120910090","2040830300","3090620040","4170470040","3090620050","1030120410",
"1030150280","1030120420","1030980120","2040140120","3110440060","2080130090","2040830310",
"2050890170","2050900180","2040830320","2080610080","3090300050","2080560080","1070390080",
"1070740160","4160410090","4150080150","1070740170","1010960080","1010070140","2040830330",
"1030980130","4180250210","1010070150","4180250220","5190010070","5190210110","5190180040",
"5190550150","1010520290","2050710080","2050900190","1010810470","1030150290","4150720200",
"1030260090","4170640150","2050900200","1030120450","4170640160","4150110120","4150200100",
"1030570230","1030490420","1030150300","4150510120","1010020260","3090430050","1030990070",
"1010960090","5190010080","1030490440","1010810480","1011020150","1010960100","1010270350",
"3110030060","1010070160","1030120460","3120700140","3110030070","1010520310","3110440070",
"4150720210","4150200110","2080610090","4180670170","1010020270","2060850150","1030260100",
"2050900210","5190010090","1010270360","1070340070","4150720220","2050870020","3120700150",
"3090360020","1030260101","2080680090","4180250230","1030490450","2080680100","3100580050",
"1010880250","3090300060","4160410100","1010960110","2050900220","3090420020","2040830331",
"4130790070","4180670180","4130380150","2040140130","1070340080","2050540200","2040140140",
"4140190060","5190010100","5190820040","4140190070","2050540170","2040830340","3120400030",
"4140190080","1030770120","2050540180","5190550151","5190550160","3110060090","5190550170",
"2060850160","5190180050","2080500030","4150110130","3120330160","4150110140","4140190090",
"2060850170","2050870030","2050900230","2060850175","4170640170","4140190100","1070340090",
"2050870040","4150720230","5190550171","3090430060","1070370100","3110440080","5190210120",
"2050540190","4150510130","2080500040","1030570240","4130380160","2080130100","2040830350",
"1010270370","3120700160","2050710090","2040830360","4170640180","4150200120","2050710100",
"4160310090","1010960120","1010810500","1030570250","2050540210","4150080160","4180670190",
"1010810510","1030490460","1010070170","3120910100","2060930090","1030570260","5190760050",
"3120910110","1010810520","4130380170","4180250240","4150720240","3100580060","1011020160",
"1030570270","1011020170","4160410110","4180670200","4160090130","4130230100","1010270380",
"2080680101","4130380180","3091000010","3120690080","1010810521","3120690090","1010020280",
"4140940050","1010070180","1030860230","3120700170","3110590080","1010810530","4130790080",
"1030240410","2050870050","2080610100","4150720250","5190550180","3090360021","3090620060",
"3090430070","3120700180","1030260110","4130380190","1030240420","4181030050","4130380200",
"4130380210","5190480080","1030120480","1030150310","3120910120","4150200130","3090420040",
"3090050060","1030490470","4130380220","4150080170","5200170110","1030150320","4130380230",
"1030260120","2050840070","4130600060","4140940060","3090300080","3090420050","1030260140",
"3120910130","3120700190","4160410120","3120910140","1010270390","3090050070","1011020180",
"4150510140","5190480100","2040830370","1030150330","1030120490","4150200140","1010810540",
"4150080180","1010070190","1010960130","1030120500","2050890180","1030150340","2060350010",
"4150200150","4160090140","4180670210","4180220160","1010270400","1010270410","4130600070",
"2040830380","4160310091","4130380240","1070340100","3110060100","1030490480","1030240430",
"1030120510","1030860240","1010810550","1070370110","3120910150","1030570280","4150510150",
"1030450090","1010020300","1030240431","4170640190","2050840080","5200170120","1070740180",
"2050540220","1010880290","1030860250","5200530132","4180670220","4180220170","4150510160",
"3090430080","1010810560","1030980140","1010020301","4180670230","1010880300","1010880310",
"1010020310","4180970030","5200730220","4180250250","4150080190","1010810570","1030240440",
"4150200160","5190550190","4150200170","1010880320","2040830390","4160310100","1030240450",
"5190760060","2060850180","5200170130","4180220190","1010810580","4160410130","3091000020",
"2050540230","1030860260","1030490490","1030120530","4180250260","1030120540","5190480110",
"1030860270","1030860280","4160780020","4160160020","4140940070","2080610110","4180250270",
"1070370120","3110590090","1030150350","1010020320","2080500050","1030490500","4160410140",
"1010520350","2080680110","4130600080","3120700200","4130230110","4160310110","4140940080",
"3090460030","2050540240","2050540250","1010020330","1070390090","1070390100","1010020340",
"4130380250","2050900250","1010270440","3110590100","1010020350","2050540260","1030490510",
"1030240460","4130230120","1030120550","2040830400","4180970040","4140190110","4130230130",
"4150200180","1010020360","4150200190","4150720280","4130230140","3120330170","1010520360",
"4130230150","4150080200","1010810590","4150720260","1030260150","4140190120","4150110150",
"1011020190","1030260160","2050540270","1030860290","3090620070","1010020380","2050840090",
"2080130110","1010020370","1010520380","2050890190","1030260170","1030260180","1030990080",
"4150720270","1030260190","2080130120","2080680120","1010270450","4130230160","1010520390",
"1030260200","1030990090","1030260210","1030450100","1010020390","4150510170","4160310120",
"1030450110","1030990100","1030450120","2050540280","4150200200","4160310130","5190480120",
"3120330180","1010520400","1030860300","4150510180","4160090150","4150510190","4150510200",
"1010880330","1070740190","1030570290","3120700210","4150200201","1010960140","3120690100",
"4150200210","4160410150","1030980150","1030490550","2060930100","1070340110","1010020400",
"1030980160","1030570300","4150510210","1030120560","3100580070","1030860310","3090620071",
"3090620080","1030570310","1010810610","1070340120","4150720290","1030990110","1030990120",
"1010810620","4150200220","2050840100","4180670240","2080680130","1030240510","1030120580",
"4150510220","3090460040","2080660050","4180250280","4130230170","1030570320","1030860320",
"1030490580","4150510230","1010070200","3120690110","1030770130","2060850190","1030980170",
"4160090160","4150080210","1030860330","1010020410","1030860340","5190760070","1030120590",
"1030240530","1030980180","1010070210","1010020420","1010020430","1030490610","3120330190",
"2050900260","1030570330","2050890200","3090420060","1010810630","1010270460","1010070220",
"1010070230","1010810640","1030570340","1030490620","1030570350","1030150360","2050900270",
"4150080220","1010070240","2080660060","4150200230","4130790090","3110030090","2040830430",
"4140940090","4130380260","3090360030","2080130140","2080130150","4130380270","5190210130",
"3110060110","5190480130","4130380280","4150200240","3120690120","3090050080","4130230180",
"1030260230","3120700220","3100800090","1030450150","2080130160","3120700230","2080130190",
"1030150380","4150200260","3100580080","1010070320","1030120610","4150720340","2080610130",
"4150720350","3120700250","2080130200","4140940120","3100800100","1070370140","4150200270",
"2050540290","1030450130","3110030080","1070740200","4140190130","5190550200","4150720300"
}
baseUrl ="http://finanzalocale.interno.it/apps/floc.php/indicatori/index/codice_ente/"
anno = "2008"
tipoEnte= "CO"

#parse html singola pagina di indicatori
for codice in arrayCodici:
    urlIFComune = baseUrl + codice + "/anno/" + anno + "/cod/8/md/0/tipo_certificato/C/tipo_ente/" + tipoEnte
    scrapeSinglePage(urlIFComune, codice)